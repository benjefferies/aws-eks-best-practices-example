version: '3'

tasks:
  helm-repo-add:
    cmds:
      - helm repo add eks https://aws.github.io/eks-charts
      - helm repo update
  
  create-argocd-applications:
    cmds:
    - |
      set -e
      for file in deployments/argocd/*; do
        kubectl apply -f $file
      done
  
  apply-infrastructure:
    vars:
      ENV: {{default "dev" .ENV}}
      COMMAND: {{default "apply" .COMMAND}}
    cmds:
      - terragrunt run-all --terragrunt-non-interactive --terragrunt-working-dir=infrastructure/envs/${ENV} ${COMMAND}